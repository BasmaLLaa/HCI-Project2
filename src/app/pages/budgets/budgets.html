<div class="panel-grid">
  <section class="card form-card" *ngIf="categories$ | async as categories">
    <div class="section-title">Create or edit budget</div>
    <form [formGroup]="form" (ngSubmit)="submit()" class="budget-form">
      <mat-form-field appearance="outline">
        <mat-label>Name</mat-label>
        <input matInput type="text" formControlName="name" placeholder="e.g. Groceries">
        <mat-error *ngIf="form.controls.name.touched && form.controls.name.invalid">Name is required</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Limit</mat-label>
        <input matInput type="number" formControlName="limit" min="50" step="50">
        <mat-error *ngIf="form.controls.limit.touched && form.controls.limit.invalid">
          Enter at least 50
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Period</mat-label>
        <mat-select formControlName="period">
          <mat-option value="Weekly">Weekly</mat-option>
          <mat-option value="Monthly">Monthly</mat-option>
          <mat-option value="Quarterly">Quarterly</mat-option>
          <mat-option value="Yearly">Yearly</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Categories</mat-label>
        <mat-select formControlName="categoryIds" multiple>
          <mat-option *ngFor="let cat of categories" [value]="cat.id">
            <span class="dot" [style.background]="cat.color"></span>
            {{ cat.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="form.controls.categoryIds.touched && form.controls.categoryIds.invalid">
          Pick at least one category
        </mat-error>
      </mat-form-field>

      <div class="actions">
        <button mat-flat-button color="primary" type="submit" [disabled]="submitting">
          {{ editingBudget ? 'Update budget' : 'Create budget' }}
        </button>
        <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="submitting">Reset</button>
      </div>
    </form>
  </section>

  <section class="card budgets-card">
    <div class="section-title">Budgets overview</div>
    <div class="budget-row" *ngFor="let budget of budgets$ | async">
      <div>
        <p class="budget-name">{{ budget.name }}</p>
        <p class="muted">
          {{ budget.period }} | {{ budget.categoryIds.length }} categories | Limit {{ budget.limit | currency }}
        </p>
        <div class="budget-tags" *ngIf="categories$ | async as cats">
          <span class="pill" *ngFor="let id of budget.categoryIds">
            <span class="dot" [style.background]="categoryColor(cats, id)"></span>
            {{ labelForCategory(cats, id) }}
          </span>
        </div>
      </div>

      <div class="budget-numbers">
        <p>{{ budget.spent | currency }} / {{ budget.limit | currency }}</p>
        <mat-progress-bar
          mode="determinate"
          [value]="(budget.spent / budget.limit) * 100"
          [color]="budget.spent > budget.limit * 0.8 ? 'warn' : 'accent'">
        </mat-progress-bar>
        <div class="row-actions">
          <button mat-stroked-button type="button" (click)="edit(budget)" [disabled]="submitting">Edit</button>
          <button mat-flat-button color="warn" type="button" (click)="delete(budget)" [disabled]="submitting">
            Delete
          </button>
        </div>
      </div>
    </div>
  </section>
</div>
