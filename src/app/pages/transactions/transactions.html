<div class="panel-grid">
  <section class="card form-card" *ngIf="(categories$ | async) as categories; else loading">
    <div class="section-title">Log a transaction</div>
    <form [formGroup]="form" (ngSubmit)="submit()" class="tx-form">
      <mat-form-field appearance="outline">
        <mat-label>Description</mat-label>
        <input matInput type="text" formControlName="description" placeholder="e.g. Coffee with friends">
        <mat-error *ngIf="form.controls.description.touched && form.controls.description.invalid">
          Please describe the transaction
        </mat-error>
      </mat-form-field>

      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Amount</mat-label>
          <input matInput type="number" formControlName="amount" min="1" step="1">
          <mat-error *ngIf="form.controls.amount.touched && form.controls.amount.invalid">
            Amount must be at least 1
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date</mat-label>
          <input matInput type="date" formControlName="date">
        </mat-form-field>
      </div>

      <div class="row">
        <mat-button-toggle-group formControlName="type" appearance="legacy" class="type-toggle">
          <mat-button-toggle value="expense">Expense</mat-button-toggle>
          <mat-button-toggle value="income">Income</mat-button-toggle>
        </mat-button-toggle-group>

        <mat-form-field appearance="outline">
          <mat-label>Payment</mat-label>
          <mat-select formControlName="paymentMethod">
            <mat-option value="card">Card</mat-option>
            <mat-option value="cash">Cash</mat-option>
            <mat-option value="transfer">Bank transfer</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select formControlName="categoryId">
          <mat-option [value]="null">Select category</mat-option>
          <mat-option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</mat-option>
        </mat-select>
        <mat-error *ngIf="form.controls.categoryId.touched && form.controls.categoryId.invalid">
          Choose where it belongs
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" *ngIf="budgets$ | async as budgets">
        <mat-label>Budget (optional)</mat-label>
        <mat-select formControlName="budgetId">
          <mat-option [value]="null">No specific budget</mat-option>
          <mat-option *ngFor="let budget of budgets" [value]="budget.id">{{ budget.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="row">
        <mat-slide-toggle formControlName="recurring">Recurring</mat-slide-toggle>
      </div>

      <div class="actions">
        <button mat-flat-button color="primary" type="submit" [disabled]="submitting">
          {{ editingTransaction ? 'Update' : 'Add' }} transaction
        </button>
        <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="submitting">Clear</button>
      </div>
    </form>
  </section>

  <section class="card list-card" *ngIf="(transactions$ | async) as txs">
    <div class="section-title">Transactions</div>
    <ng-container *ngIf="categories$ | async as categories">
      <div class="tx-row" *ngFor="let tx of txs; trackBy: trackByTx">
        <div class="tx-meta">
          <app-status-pill
            [label]="tx.type | titlecase"
            [type]="tx.type"
            (pillClick)="edit(tx)">
          </app-status-pill>
          <div>
            <p class="tx-desc">{{ tx.description }}</p>
            <p class="muted">
              {{ tx.date | date:'mediumDate' }} | {{ categoryName(categories, tx.categoryId) }}
            </p>
          </div>
        </div>
        <p [ngClass]="{ positive: tx.type === 'income', negative: tx.type === 'expense' }">
          {{ tx.type === 'income' ? '+' : '-' }}{{ tx.amount | currency }}
        </p>
        <div class="row-actions">
          <button mat-stroked-button type="button" (click)="edit(tx)" [disabled]="submitting">Edit</button>
          <button mat-flat-button color="warn" type="button" (click)="delete(tx)" [disabled]="submitting">Delete</button>
        </div>
      </div>
    </ng-container>
  </section>
</div>

<ng-template #loading>
  <p class="muted">Loading categories...</p>
</ng-template>
